<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        :root { --bg: #f4f4f9; --card: #ffffff; --text: #333; --primary: #3390ec; --danger: #dc3545; --border: #e0e0e0; --sidebar-width: 250px; }
        body { font-family: system-ui; background: var(--bg); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; }
        .app-container { display: flex; width: 100%; height: 100%; }
        .sidebar { width: var(--sidebar-width); background: #2c3e50; color: white; display: flex; flex-direction: column; padding: 20px; }
        .brand { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #455a64; padding-bottom: 10px; }
        .nav-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; opacity: 0.8; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.1); opacity: 1; }
        .nav-section { margin-top: auto; border-top: 1px solid #455a64; padding-top: 15px; }
        .main-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        #auth-screen { max-width: 400px; margin: 100px auto; background: var(--card); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; }
        #auth-screen input { width: 90%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 6px; }
        
        .panel { display: none; }
        .panel.active { display: block; }
        
        .section { background: var(--card); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section h2 { margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .controls input, .controls select { padding: 10px; border: 1px solid var(--border); border-radius: 6px; flex: 1; min-width: 120px; }
        
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-success { background: #28a745; color: white; }

        .table-container { overflow-x: auto; max-height: 60vh; border: 1px solid var(--border); border-radius: 6px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 600px; }
        th, td { padding: 10px; border-bottom: 1px solid var(--border); text-align: left; white-space: nowrap; }
        th { background: #f8f9fa; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: #f1f1f1; }

        .mobile-header { display: none; background: #2c3e50; color: white; padding: 10px 15px; justify-content: space-between; }
        .hamburger { cursor: pointer; font-size: 1.5rem; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 80%; max-width: 280px; background: #2c3e50; box-shadow: 2px 0 10px rgba(0,0,0,0.3); transition: transform 0.3s; z-index: 100; }
            .sidebar.open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .main-content { padding: 10px; padding-top: 15px; }
            .controls { flex-direction: column; }
            .controls input, .controls select, .controls button { width: 100%; margin-bottom: 5px; }
            .table-container { max-height: 50vh; }
            .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 90; display: none; }
            .overlay.active { display: block; }
        }
        
        body.auth-mode .sidebar, body.auth-mode .mobile-header { display: none; }
        body.auth-mode .main-content { padding-top: 0; display: flex; align-items: center; justify-content: center; height: 100%; }
    </style>
</head>
<body class="auth-mode">

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="brand">Admin Control</div>
            <div class="nav-item" onclick="switchTab('users')" id="nav-users">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="nav-item" onclick="switchTab('broadcast')" id="nav-broadcast">üì¢ –†–∞—Å—Å—ã–ª–∫–∏ (Log)</div>
            <div class="nav-section">
                <div id="nav-pass-block" style="display:none; margin-bottom: 10px;">
                    <input type="password" id="old-pass" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" style="width:100%; margin-bottom:5px; padding:8px;">
                    <input type="password" id="new-pass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" style="width:100%; margin-bottom:5px; padding:8px;">
                    <button class="btn-outline" style="width:100%; color: white; border-color: #555;" onclick="changePassword()">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </div>
                <button class="btn-danger" style="width:100%;" onclick="logout()">–í—ã—Ö–æ–¥</button>
            </div>
        </div>

        <div class="main-content">
            <div class="mobile-header">
                <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
                <span>Admin Panel</span>
            </div>

            <div id="auth-screen">
                <h2>–í—Ö–æ–¥ –≤ –ø–∞–Ω–µ–ª—å</h2>
                <input type="password" id="admin-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                <button class="btn-primary" onclick="login()">–í–æ–π—Ç–∏</button>
                <div id="auth-msg" style="margin-top: 10px; color: red;"></div>
            </div>

            <div id="panel-users" class="panel">
                <div class="section">
                    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏</h2>
                    <div class="controls">
                        <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ (ID, –ò–º—è, –ö–æ–º–º–µ–Ω—Ç)">
                        <select id="user-sort">
                            <option value="id|DESC">–ù–æ–≤—ã–µ (ID DESC)</option>
                            <option value="id|ASC">–°—Ç–∞—Ä—ã–µ (ID ASC)</option>
                            <option value="user_id|ASC">User ID</option>
                        </select>
                        <button class="btn-primary" onclick="loadUsers()">–ù–∞–π—Ç–∏</button>
                    </div>
                    <div class="controls" style="background: #eef6ff; padding: 10px; border-radius: 6px; border: 1px solid #cce4ff;">
                        <input type="text" id="msg-to-users" placeholder="–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏...">
                        <button class="btn-primary" onclick="broadcastToSelected()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä.</button>
                        <button class="btn-danger" onclick="deleteSelected('users')">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä.</button>
                        <button class="btn-success" onclick="downloadCSV()">–°–∫–∞—á–∞—Ç—å CSV</button>
                    </div>
                    <div class="table-container">
                        <table id="users-table">
                            <thead><tr>
                                <th style="width: 40px;"><input type="checkbox" onchange="toggleAll('users', this)"></th>
                                <th>ID</th>
                                <th>–ò–º—è (@username)</th>
                                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                                <th>–î–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="panel-broadcast" class="panel">
                <div class="section">
                    <h2>–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</h2>
                    <div class="controls">
                        <input type="text" id="broadcast-search" placeholder="–ü–æ–∏—Å–∫ —Ç–µ–∫—Å—Ç–∞">
                        <select id="broadcast-sort">
                            <option value="id|DESC">–ù–æ–≤—ã–µ (ID DESC)</option>
                            <option value="timestamp|DESC">–°–≤–µ–∂–∏–µ –ø–æ –¥–∞—Ç–µ</option>
                        </select>
                        <button class="btn-primary" onclick="loadBroadcasts()">–ù–∞–π—Ç–∏</button>
                    </div>
                    <div class="table-container">
                        <table id="broadcast-table">
                            <thead><tr>
                                <th style="width: 40px;"><input type="checkbox" onchange="toggleAll('broadcast', this)"></th>
                                <th>ID</th>
                                <th>–î–∞—Ç–∞</th>
                                <th>–¢–∏–ø</th>
                                <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                                <th>ID –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Helpers
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            sb.classList.toggle('open');
            ov.classList.toggle('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.add('active');
            document.getElementById(`nav-${tabName}`).classList.add('active');
            if(tabName === 'users') loadUsers();
            if(tabName === 'broadcast') loadBroadcasts();
            if (window.innerWidth <= 768) toggleSidebar();
        }

        async function login() {
            const pass = document.getElementById('admin-pass').value;
            const msg = document.getElementById('auth-msg');
            if(!pass) return;
            const res = await fetch('/api/admin/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({password: pass}) });
            const data = await res.json();
            if(data.status === 'success' || data.status === 'new_password_set') {
                document.body.classList.remove('auth-mode');
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('panel-users').classList.add('active');
                document.getElementById('nav-users').classList.add('active');
                document.getElementById('nav-pass-block').style.display = 'block';
                loadUsers();
            } else { msg.innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å"; }
        }

        async function changePassword() {
            const oldP = document.getElementById('old-pass').value;
            const newP = document.getElementById('new-pass').value;
            if(!oldP || !newP) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è");
            const res = await fetch('/api/admin/change_password', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({old_password: oldP, new_password: newP}) });
            if(res.ok) { alert("–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω!"); document.getElementById('old-pass').value=""; document.getElementById('new-pass').value=""; } 
            else { alert("–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å."); }
        }

        function logout() { window.location.reload(); }

        // Data Loading
        async function loadUsers() {
            const search = document.getElementById('user-search').value;
            const sortVal = document.getElementById('user-sort').value.split('|');
            const params = new URLSearchParams({ search: search, sort_by: sortVal[0], order: sortVal[1] });
            const res = await fetch(`/api/admin/manage/users?${params.toString()}`);
            const data = await res.json();
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = data.map(u => `
                <tr>
                    <td><input type="checkbox" class="check-item" value="${u.user_id}"></td>
                    <td>${u.user_id}</td>
                    <td>${u.first_name} <br><small>@${u.username || 'no'}</small></td>
                    <td>${u.comment || '-'}</td>
                    <td>${u.subscribe_date}</td>
                </tr>
            `).join('');
        }

        async function loadBroadcasts() {
            const search = document.getElementById('broadcast-search').value;
            const sortVal = document.getElementById('broadcast-sort').value.split('|');
            const params = new URLSearchParams({ search: search, sort_by: sortVal[0], order: sortVal[1] });
            const res = await fetch(`/api/admin/manage/broadcast_log?${params.toString()}`);
            const data = await res.json();
            const tbody = document.querySelector('#broadcast-table tbody');
            tbody.innerHTML = data.map(b => `
                <tr>
                    <td><input type="checkbox" class="check-broadcast" value="${b.id}"></td>
                    <td>${b.id}</td>
                    <td>${b.timestamp}</td>
                    <td>${b.recipient_type}</td>
                    <td title="${b.message}">${b.message.substring(0, 50)}${b.message.length > 50 ? '...' : ''}</td>
                    <td><small>${b.user_ids || '-'}</small></td>
                </tr>
            `).join('');
        }

        // Actions
        function toggleAll(type, checkbox) {
            const cls = type === 'users' ? '.check-item' : '.check-broadcast';
            document.querySelectorAll(cls).forEach(c => c.checked = checkbox.checked);
        }

        function getCheckedIds(type) {
            const cls = type === 'users' ? '.check-item' : '.check-broadcast';
            return Array.from(document.querySelectorAll(cls + ':checked')).map(c => parseInt(c.value));
        }

        async function deleteSelected(type) {
            const ids = getCheckedIds(type);
            if(ids.length === 0) return alert("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏");
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å ${ids.length} –∑–∞–ø–∏—Å–µ–π?`)) return;
            const table = type === 'users' ? 'users' : 'broadcast_log';
            await fetch(`/api/admin/manage/${table}`, { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ ids: ids }) });
            if(type === 'users') loadUsers(); else loadBroadcasts();
        }

        async function broadcastToSelected() {
            const ids = getCheckedIds('users');
            const msg = document.getElementById('msg-to-users').value;
            if(ids.length === 0) return alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
            if(!msg) return alert("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ");
            if(!confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ ${ids.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) return;
            const res = await fetch('/api/admin/manage/users', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ message: msg, target_ids: ids }) });
            if(res.ok) {
                alert("–†–∞—Å—Å—ã–ª–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
                document.getElementById('msg-to-users').value = "";
                switchTab('broadcast');
            } else {
                alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏");
            }
        }

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø CSV ---
        async function downloadCSV() {
            const btn = event.target;
            const originalText = btn.innerText;

            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            btn.innerText = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∞–π–ª–∞...";
            btn.disabled = true;

            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                const search = document.getElementById('user-search').value;
                const sortVal = document.getElementById('user-sort').value.split('|');
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL
                const url = `/api/admin/export/users?${new URLSearchParams({ 
                    search: search, 
                    sort_by: sortVal[0], 
                    order: sortVal[1] 
                }).toString()}`;

                // === –ú–ï–¢–û–î –î–õ–Ø TELEGRAM WEB APP ===
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º URL –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ/–æ–∫–Ω–µ. 
                // –í –º–æ–±–∏–ª—å–Ω–æ–º –¢–µ–ª–µ–≥—Ä–∞–º —ç—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (–∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π), 
                // –≥–¥–µ –±—ç–∫–µ–Ω–¥ –æ—Ç–¥–∞—Å—Ç —Ñ–∞–π–ª, –∏ –±—Ä–∞—É–∑–µ—Ä –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –µ–≥–æ —Å–∫–∞—á–∞—Ç—å.
                window.open(url, '_blank');

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ –≤—Ä–µ–º—è
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }, 1500);

            } catch (error) {
                console.error(error);
                alert("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: " + error.message);
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
        
        document.getElementById('user-search').addEventListener('keypress', (e) => { if(e.key==='Enter') loadUsers(); });
        document.getElementById('broadcast-search').addEventListener('keypress', (e) => { if(e.key==='Enter') loadBroadcasts(); });
    </script>
</body>
</html>